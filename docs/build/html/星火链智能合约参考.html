<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>星火链智能合约参考 &mdash; 星火链开发者手册 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="星火链Solidity合约开发" href="%E6%98%9F%E7%81%AB%E9%93%BESolidity%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> 星火链开发者手册
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">星火链应用开发手册:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="%E6%A6%82%E8%BF%B0.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%98%9F%E7%81%AB%E9%93%BE%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">星火链开发基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%98%9F%E7%81%AB%E9%93%BESDK.html">星火链SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%98%9F%E7%81%AB%E9%93%BEJavascript%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91.html">星火链Javascript合约开发</a></li>
<li class="toctree-l1"><a class="reference internal" href="%E6%98%9F%E7%81%AB%E9%93%BESolidity%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91.html">星火链Solidity合约开发</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">星火链智能合约参考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#erc20">ERC20合约</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solidity">Solidity 合约</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#erc721">ERC721合约</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Solidity合约</a></li>
<li class="toctree-l3"><a class="reference internal" href="#javascript">JavaScript合约</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#erc1155">ERC1155合约</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">合约说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Solidity合约</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">JavaScript合约</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">星火链开发者手册</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>星火链智能合约参考</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/星火链智能合约参考.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>星火链智能合约参考<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>​本节为星火链智能合约的示例。</p>
<section id="erc20">
<h2>ERC20合约<a class="headerlink" href="#erc20" title="Permalink to this headline"></a></h2>
<h2 id="min-content" style="display:none;"> </h2>
​
本节描述通过星火链网实现并部署ERC20智能合约。
<p>​ERC20可以简单理解成以太坊上的一个代币协议，所有基于以太坊开发的代币合约都遵守这个协议。有关ERC20标准可以参考<a class="reference external" href="https://theethereum.wiki/w/index.php/ERC20_Token_Standard">官方文档</a>。</p>
<section id="id2">
<h3>说明<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>合约接口</strong></p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接口</p></th>
<th class="head"><p>返回值</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>name()</p></td>
<td><p>string</p></td>
<td><p>代币名称获取</p></td>
</tr>
<tr class="row-odd"><td><p>symbol()</p></td>
<td><p>string</p></td>
<td><p>代币符号获取</p></td>
</tr>
<tr class="row-even"><td><p>totalSupply()</p></td>
<td><p>uint256</p></td>
<td><p>发行方总代币金额获取</p></td>
</tr>
<tr class="row-odd"><td><p>transfer(address to,uint256 value)</p></td>
<td><p>无</p></td>
<td><p>代币转移接口，从自己（创建交易者）账号发送<code class="docutils literal notranslate"><span class="pre">_value</span></code>个代币到 <code class="docutils literal notranslate"><span class="pre">_to</span></code>账号</p></td>
</tr>
<tr class="row-even"><td><p>allowance(address,address)</p></td>
<td><p>无</p></td>
<td><p>账号所有者操作列表</p></td>
</tr>
<tr class="row-odd"><td><p>transferFrom(address from,address to,uint256 value)</p></td>
<td><p>无</p></td>
<td><p>账号之间代币交易转移<br />from 发送者地址<br />to 接收者地址<br />value 转移数额</p></td>
</tr>
<tr class="row-even"><td><p>approve(address spender,uint256 value)</p></td>
<td><p>无</p></td>
<td><p>设置某个地址（合约）可以创建交易者名义花费的代币数，允许发送者<code class="docutils literal notranslate"><span class="pre">_spender</span></code> 花费不多于 <code class="docutils literal notranslate"><span class="pre">_value</span></code> 个代币</p></td>
</tr>
<tr class="row-odd"><td><p>burn(uint256 value)</p></td>
<td><p>无</p></td>
<td><p>销毁我（创建交易者）账户中指定个代币</p></td>
</tr>
<tr class="row-even"><td><p>burnFrom(address from, uint256 value)</p></td>
<td><p>无</p></td>
<td><p>销毁用户账户中指定个代币</p></td>
</tr>
</tbody>
</table>
</section>
<section id="solidity">
<h3>Solidity 合约<a class="headerlink" href="#solidity" title="Permalink to this headline"></a></h3>
<div class="highlight-solidity notranslate"><div class="highlight"><pre><span></span><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.4.26</span><span class="p">;</span><span class="w"></span>

<span class="k">contract</span><span class="w"> </span><span class="ni">TokenERC20</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="k">public </span><span class="nv">name</span><span class="p">;</span><span class="w"> </span><span class="c1">// ERC20标准</span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="k">public </span><span class="nv">symbol</span><span class="p">;</span><span class="w"> </span><span class="c1">// ERC20标准</span>
<span class="w">    </span><span class="kt">uint8</span><span class="w"> </span><span class="k">public </span><span class="nv">decimals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">;</span><span class="w">  </span><span class="c1">// ERC20标准，decimals 可以有的小数点个数，最小的代币单位。18 是建议的默认值</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">totalSupply</span><span class="p">;</span><span class="w"> </span><span class="c1">// ERC20标准 总供应量</span>

<span class="w">    </span><span class="c1">// 用mapping保存每个地址对应的余额 ERC20标准</span>
<span class="w">    </span><span class="kt">mapping</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>balanceOf<span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 存储对账号的控制 ERC20标准</span>
<span class="w">    </span><span class="kt">mapping</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">mapping</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">uint256</span><span class="p">))</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>allowance<span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 事件，用来通知客户端交易发生 ERC20标准</span>
<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">Transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>from<span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>to<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">value</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// 事件，用来通知客户端代币被消费 ERC20标准</span>
<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">Burn</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>from<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">value</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 初始化构造</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">TokenERC20</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">initialSupply</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nv">tokenName</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nv">tokenSymbol</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>totalSupply<span class="w"> </span><span class="o">=</span><span class="w"> </span>initialSupply<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span>decimals<span class="p">);</span><span class="w">  </span><span class="c1">// 供应的份额，份额跟最小的代币单位有关，份额 = 币数 * 10 ** decimals。</span>
<span class="w">        </span>balanceOf<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>totalSupply<span class="p">;</span><span class="w">                </span><span class="c1">// 创建者拥有所有的代币</span>
<span class="w">        </span>name<span class="w"> </span><span class="o">=</span><span class="w"> </span>tokenName<span class="p">;</span><span class="w">                                   </span><span class="c1">// 代币名称</span>
<span class="w">        </span>symbol<span class="w"> </span><span class="o">=</span><span class="w"> </span>tokenSymbol<span class="p">;</span><span class="w">                               </span><span class="c1">// 代币符号</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 代币交易转移的内部实现</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">_transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_from</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">_to</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 确保目标地址不为0x0，因为0x0地址代表销毁</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>_to<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 检查发送者余额</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// 确保转移为正数个</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>balanceOf<span class="p">[</span>_to<span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>_value<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>balanceOf<span class="p">[</span>_to<span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 以下用来检查交易，</span>
<span class="w">        </span><span class="kt">uint</span><span class="w"> </span><span class="nv">previousBalances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>balanceOf<span class="p">[</span>_to<span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Subtract from the sender</span>
<span class="w">        </span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Add the same to the recipient</span>
<span class="w">        </span>balanceOf<span class="p">[</span>_to<span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>_value<span class="p">;</span><span class="w"></span>
<span class="w">        </span>Transfer<span class="p">(</span>_from<span class="p">,</span><span class="w"> </span>_to<span class="p">,</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 用assert来检查代码逻辑。</span>
<span class="w">        </span>assert<span class="p">(</span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>balanceOf<span class="p">[</span>_to<span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>previousBalances<span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     *  代币交易转移</span>
<span class="cm">     *  从自己（创建交易者）账号发送`_value`个代币到 `_to`账号</span>
<span class="cm">     * ERC20标准</span>
<span class="cm">     * @param _to 接收者地址</span>
<span class="cm">     * @param _value 转移数额</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">transfer</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_to</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>_transfer<span class="p">(</span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>_to<span class="p">,</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 账号之间代币交易转移</span>
<span class="cm">     * ERC20标准</span>
<span class="cm">     * @param _from 发送者地址</span>
<span class="cm">     * @param _to 接收者地址</span>
<span class="cm">     * @param _value 转移数额</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">transferFrom</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_from</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">_to</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>_value<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>allowance<span class="p">[</span>_from<span class="p">][</span><span class="k">msg.sender</span><span class="p">]);</span><span class="w">     </span><span class="c1">// Check allowance</span>
<span class="w">        </span>allowance<span class="p">[</span>_from<span class="p">][</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w"></span>
<span class="w">        </span>_transfer<span class="p">(</span>_from<span class="p">,</span><span class="w"> </span>_to<span class="p">,</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 设置某个地址（合约）可以创建交易者名义花费的代币数。</span>
<span class="cm">     *</span>
<span class="cm">     * 允许发送者`_spender` 花费不多于 `_value` 个代币</span>
<span class="cm">     * ERC20标准</span>
<span class="cm">     * @param _spender The address authorized to spend</span>
<span class="cm">     * @param _value the max amount they can spend</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">approve</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_spender</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"></span>
<span class="w">    </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>allowance<span class="p">[</span><span class="k">msg.sender</span><span class="p">][</span>_spender<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_value<span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 销毁我（创建交易者）账户中指定个代币</span>
<span class="cm">     *-非ERC20标准</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">burn</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>balanceOf<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>_value<span class="p">);</span><span class="w">   </span><span class="c1">// Check if the sender has enough</span>
<span class="w">        </span>balanceOf<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w">            </span><span class="c1">// Subtract from the sender</span>
<span class="w">        </span>totalSupply<span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w">                      </span><span class="c1">// Updates totalSupply</span>
<span class="w">        </span>Burn<span class="p">(</span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 销毁用户账户中指定个代币</span>
<span class="cm">     *-非ERC20标准</span>
<span class="cm">     * Remove `_value` tokens from the system irreversibly on behalf of `_from`.</span>
<span class="cm">     *</span>
<span class="cm">     * @param _from the address of the sender</span>
<span class="cm">     * @param _value the amount of money to burn</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">burnFrom</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_from</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="nv">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>_value<span class="p">);</span><span class="w">                </span><span class="c1">// Check if the targeted balance is enough</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>_value<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>allowance<span class="p">[</span>_from<span class="p">][</span><span class="k">msg.sender</span><span class="p">]);</span><span class="w">    </span><span class="c1">// Check allowance</span>
<span class="w">        </span>balanceOf<span class="p">[</span>_from<span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w">                         </span><span class="c1">// Subtract from the targeted balance</span>
<span class="w">        </span>allowance<span class="p">[</span>_from<span class="p">][</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w">             </span><span class="c1">// Subtract from the sender&#39;s allowance</span>
<span class="w">        </span>totalSupply<span class="w"> </span><span class="o">-=</span><span class="w"> </span>_value<span class="p">;</span><span class="w">                              </span><span class="c1">// Update totalSupply</span>
<span class="w">        </span>Burn<span class="p">(</span>_from<span class="p">,</span><span class="w"> </span>_value<span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="erc721">
<h2>ERC721合约<a class="headerlink" href="#erc721" title="Permalink to this headline"></a></h2>
<p>​本节描述通过星火链网实现并部署ERC721智能合约。</p>
<p>相比于ERC20，ERC721是非同质化代币，也就意味着每个Token都是不一样的，都有自己的唯一性和独特价值，当然这也就意味着它们是不可分割的。有关ERC721标准可以参考<a class="reference external" href="https://eips.ethereum.org/EIPS/eip-721">官方文档</a>。</p>
<section id="id3">
<h3>说明<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>合约接口</strong></p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接口</p></th>
<th class="head"><p>返回值</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>name()</p></td>
<td><p>string</p></td>
<td><p>代币名称获取</p></td>
</tr>
<tr class="row-odd"><td><p>symbol()</p></td>
<td><p>string</p></td>
<td><p>代币符号获取</p></td>
</tr>
<tr class="row-even"><td><p>tokenURI()</p></td>
<td><p>无</p></td>
<td><p>根据tokenid 去查询的，通常为一个json字符串，描述了 NFT的图片、介绍等详细信息。</p></td>
</tr>
<tr class="row-odd"><td><p>balanceOf(address _owner)</p></td>
<td><p>uint256</p></td>
<td><p>获取 用户_ owner 所有NFT代币的数量</p></td>
</tr>
<tr class="row-even"><td><p>ownerOf(uint256_tokenId)</p></td>
<td><p>address</p></td>
<td><p>查询拥有tokenID号为 _tokenId 的NFT的 所属者owner的地址</p></td>
</tr>
<tr class="row-odd"><td><p>transferFrom(address _from, address _to, uint256 _tokenId)</p></td>
<td><p>无</p></td>
<td><p>将tokenID 为 _tokenId 的NFT 从 _from地址的用户 转移到 _to地址的用户</p></td>
</tr>
<tr class="row-even"><td><p>safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes data )</p></td>
<td><p>无</p></td>
<td><p>安全地将tokenID 为 _tokenId 的NFT 从 _from地址的用户 转移到 _to地址的用户, 并携带 data数据；安全地是指：需要判断 _to的地址，是合约账户地址，还是用户账户地址。若为合约地址，该这个合约必须实现ERC721TokenReceiver接口。</p></td>
</tr>
<tr class="row-odd"><td><p>safeTransferFrom(address _from, address _to, uint256 _tokenId)</p></td>
<td><p>无</p></td>
<td><p>安全地将tokenID 为 _tokenId 的NFT 从 _from地址的用户 转移到 _to地址的用户</p></td>
</tr>
<tr class="row-even"><td><p>approve(address _approved, uint256 _tokenId)</p></td>
<td><p>无</p></td>
<td><p>授权， _tokenId的拥有者 将_tokenId对应的 NFT 授权给 _approved 去操作</p></td>
</tr>
<tr class="row-odd"><td><p>getApproved (uint256 _tokenId)</p></td>
<td><p>address</p></td>
<td><p>获取 某个账户取得了_tokenId对应代币的授权</p></td>
</tr>
<tr class="row-even"><td><p>setApprovalForAll(address _operator, bool _approved)</p></td>
<td><p>无</p></td>
<td><p>将自己所有的NFT 授权 给 <em>operator 用户。</em> approved 为true时，代表授权，为false时，代表取消授权</p></td>
</tr>
<tr class="row-odd"><td><p>isApprovedForAll(address _owner, address _operator)</p></td>
<td><p>bool</p></td>
<td><p>查询_operator 是否拥有了 _owner所有NFT的 授权。</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id4">
<h3>Solidity合约<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<div class="highlight-solidity notranslate"><div class="highlight"><pre><span></span>pragma solidity ^0.4.26;

contract XHERC721  {

    address public fundation; // 管理员  
    
    // 代币名称
    string private _name;

    // 代币符号
    string private _symbol;

    // NFT 属于哪个账户的
    mapping(uint256 =&gt; address) private _tokens;

    // 账户有 几个NFT
    mapping(address =&gt; uint256) private _balanceOf;

    // 授权集合
    mapping(uint256 =&gt; address) private _allowances;

    // Mapping from owner to operator approvals 全部 NFT 的授权集合
    mapping(address =&gt; mapping(address =&gt; bool)) private _isAllApproved;

    
    // 三个事件
    event Transfer(address indexed _from, address indexed _to, uint256 indexed _tokenId);
    event Approval(address indexed _owner, address indexed _approved, uint256 indexed _tokenId);
    event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);

    /**
     * 初始化构造
     */
    function TokenERC721(string memory name_, string memory symbol_) public {
        _name = name_;
        _symbol = symbol_;
	    fundation = msg.sender; 
    }
    
    constructor() {
        fundation = msg.sender;    
    }
    

    modifier onlyFundation() {
        require(msg.sender == fundation);
        _;
    }

    // 可选
    function name() public view returns (string memory) {
        return _name;
    }
    function symbol() public view returns (string memory) {
        return _symbol;
    }
    
    //function url() virtual public view returns (uint8);

    // 必须实现 ----  9个方法
    function balanceOf(address owner) public view returns (uint256) {
        require(owner != address(0), &quot;ERC721: balance query for the zero address&quot;);
        return _balanceOf[owner];
    }

    // 代币的地址
    function ownerOf(uint256 tokenId) public view returns (address) {
        address owner = _tokens[tokenId];
        require(owner != address(0), &quot;ERC721: owner query for nonexistent token&quot;);
        return owner;
    }

    /**
     * 创建NFT。
     * @param to 接收方
     * @param tokenId 代币的标识符
     */
    function mint(address to, uint256 tokenId) public onlyFundation {
        require(to != address(0), &quot;ERC721: mint to the zero address&quot;);
        require(!_exists(tokenId), &quot;ERC721: token already minted&quot;);

        _balanceOf[to] += 1;
        _tokens[tokenId] = to;

        emit Transfer(address(0), to, tokenId);
    }
    
    function _burn(uint256 tokenId) internal {
        address owner = XHERC721.ownerOf(tokenId);

        // Clear approvals
        _approve(address(0), tokenId);

        _balanceOf[owner] -= 1;
        delete _tokens[tokenId];

        emit Transfer(owner, address(0), tokenId);
    }
    
    function transferFrom(
        address from,
        address to,
        uint256 tokenId
    ) public {
        require(_isApprovedOrOwner(msg.sender, tokenId), &quot;ERC721: transfer caller is not owner nor approved&quot;);
        _transfer(from, to, tokenId);
    }
    
    /**
     * 从地址转账。合约调用方须是经过_from授权的账户
     * @param from 发送方
     * @param to 接收方
     * @param tokenId 代币的标识符
     */
    function _transfer(
        address from,
        address to,
        uint256 tokenId
    ) internal {
        require(XHERC721.ownerOf(tokenId) == from, &quot;ERC721: transfer from incorrect owner&quot;);
        require(to != address(0), &quot;ERC721: transfer to the zero address&quot;);

        _approve(address(0), tokenId);

        _balanceOf[from] -= 1;
        _balanceOf[to] += 1;
        _tokens[tokenId] = to;

        emit Transfer(from, to, tokenId);
    }

    // 要实现转账，先实现授权。
    function safeTransferFrom(
        address from,
        address to,
        uint256 tokenId
    ) public {
        safeTransferFrom(from, to, tokenId, &quot;&quot;);
    }
    
    function safeTransferFrom(
        address from,
        address to,
        uint256 tokenId,
        bytes memory _data
    ) public {
        require(_isApprovedOrOwner(msg.sender, tokenId), &quot;ERC721: transfer caller is not owner nor approved&quot;);
        _safeTransfer(from, to, tokenId, _data);
    }
    
    function _safeTransfer(
        address from,
        address to,
        uint256 tokenId,
        bytes memory _data
    ) internal {
        _transfer(from, to, tokenId);
    }


    /**
     * 授权
     * @param to 接受授权的账户地址
     * @param tokenId 代币的标识符
     */
    function approve(address to, uint256 tokenId) public  {
        address owner = XHERC721.ownerOf(tokenId);
        require(to != owner, &quot;ERC721: approval to current owner&quot;);

        require(
            msg.sender == owner || isApprovedForAll(owner, msg.sender),
            &quot;ERC721: approve caller is not owner nor approved for all&quot;
        );

        _approve(to, tokenId);
    }
    
    function _approve(address to, uint256 tokenId) internal {
        _allowances[tokenId] = to;
        emit Approval(XHERC721.ownerOf(tokenId), to, tokenId);
    }

    /**
     * 查看接受授权的账户地址
     * @param tokenId 代币的标识符
     */
    function getApproved(uint256 tokenId) public view  returns (address) {
        require(_exists(tokenId), &quot;ERC721: approved query for nonexistent token&quot;);

        return _allowances[tokenId];
    }

    
    function _exists(uint256 tokenId) internal view returns (bool) {
        return _tokens[tokenId] != address(0);
    }

    /**
     * 拥有者将其所有NFT进行全部授权
     * @param operator 接受授权的账户地址
     * @param approved 是否授权
     */
    function setApprovalForAll(address operator, bool approved) public {
        _setApprovalForAll(msg.sender, operator, approved);
    }
   
    function _setApprovalForAll(
        address owner,
        address operator,
        bool approved
    ) internal {
        require(owner != operator, &quot;ERC721: approve to caller&quot;);
        _isAllApproved[owner][operator] = approved;
        emit ApprovalForAll(owner, operator, approved);
    }
    
    function isApprovedForAll(address owner, address operator) public view returns (bool) {

        require(owner != address(0), &quot;_owner can not be empty!&quot;);
        require(operator != address(0), &quot;_operator can not be empty!&quot;);

        return  _isAllApproved[owner][operator];
    }

        
    function _isApprovedOrOwner(address spender, uint256 tokenId) internal view returns (bool) {
        require(_exists(tokenId), &quot;ERC721: operator query for nonexistent token&quot;);
        address owner = XHERC721.ownerOf(tokenId);
        return (spender == owner || getApproved(tokenId) == spender || isApprovedForAll(owner, spender));
    }

}
</pre></div>
</div>
</section>
<section id="javascript">
<h3>JavaScript合约<a class="headerlink" href="#javascript" title="Permalink to this headline"></a></h3>
<p>**合约文件 - JavaScript **</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="c1">// 管理员  </span>
<span class="kd">const</span> <span class="nx">_fundation</span> <span class="o">=</span> <span class="s2">&quot;_fundation&quot;</span><span class="p">;</span>

<span class="c1">// 代币名称</span>
<span class="kd">const</span> <span class="nx">_name</span> <span class="o">=</span> <span class="s2">&quot;_name&quot;</span><span class="p">;</span>

<span class="c1">// 代币符号</span>
<span class="kd">const</span> <span class="nx">_symbol</span> <span class="o">=</span> <span class="s2">&quot;_symbol&quot;</span><span class="p">;</span>


<span class="c1">// 账户有 几个NFT      address =&gt; uint256</span>
<span class="kd">const</span> <span class="nx">BALANCEOF</span> <span class="o">=</span> <span class="s2">&quot;_balanceOf&quot;</span><span class="p">;</span>

<span class="c1">// NFT 属于哪个账户的    uint256 =&gt; address</span>
<span class="kd">var</span> <span class="nx">TOKENS</span> <span class="o">=</span> <span class="s2">&quot;_tokens&quot;</span><span class="p">;</span>

<span class="c1">// 授权集合    uint256 =&gt; address</span>
<span class="kd">const</span> <span class="nx">ALLOWANCES</span> <span class="o">=</span> <span class="s2">&quot;_allowances&quot;</span><span class="p">;</span>

<span class="c1">// 全部 NFT 的授权集合    address =&gt; mapping(address =&gt; bool)</span>
<span class="kd">const</span> <span class="nx">ISALLAPPROVED</span> <span class="o">=</span> <span class="s2">&quot;_isAllApproved&quot;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">sender_g</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">chainCode_g</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">chainCode</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">	是否为合约所有者</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">isContractOwner</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">_fundation</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">===</span> <span class="nx">owner</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">input_str</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;input_str: (&#39;</span> <span class="o">+</span> <span class="nx">input_str</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s2">&quot;_name&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s2">&quot;_symbol&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">symbol</span><span class="p">);</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s2">&quot;_fundation&quot;</span><span class="p">,</span> <span class="nx">sender_g</span><span class="p">);</span>
        
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span> 


<span class="c1">// 可选</span>
<span class="kd">function</span> <span class="nx">nameOfNFT</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s2">&quot;_name&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">symbol</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s2">&quot;_symbol&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_exists</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// 二维数组</span>
    <span class="kd">var</span> <span class="nx">dataToken</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dataToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">dataToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>  
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 必须实现 ----  9个方法</span>
<span class="kd">function</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">owner</span><span class="p">;</span> 

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span> <span class="p">,</span> <span class="s2">&quot;ERC721: balance query for the zero address&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">balances</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">BALANCEOF</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">balances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">owner</span><span class="p">];</span>  
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="mf">0</span><span class="p">;</span>    
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 代币的地址</span>
<span class="kd">function</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">dataToken</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dataToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">dataToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">];</span>  
    <span class="p">}</span>
    
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;ERC721: owner query for nonexistent token&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">owner</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* 返回NFT的 拥有者。</span>
<span class="cm">* @param params </span>
<span class="cm">* @param params.tokenId 代币的标识符</span>

<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">ownerOf</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tokenId</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* 创建NFT。</span>
<span class="cm">* @param _tokenId 代币的标识符</span>
<span class="cm">* @param owner 拥有者</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">mint</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">isContractOwner</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">){</span>
        <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mint&#39;</span> <span class="o">+</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tokenId</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">;</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mint-params: &#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">);</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span> <span class="p">,</span> <span class="s2">&quot;ERC721: mint to the zero address&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="nx">_exists</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">),</span> <span class="s2">&quot;ERC721: token already minted&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">balances</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">BALANCEOF</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">balances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">];</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span> <span class="o">+</span> <span class="mf">1</span><span class="p">;</span>  
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span>  
    <span class="p">}</span>
      
    <span class="c1">// 读取 tokens 集合</span>
    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">dataToken</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dataToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">dataToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">tokens</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">BALANCEOF</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">balances</span><span class="p">));</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
     
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;Transfer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__setApproved</span><span class="p">(</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 读取 allowance 集合</span>
    <span class="kd">var</span> <span class="nx">allowances</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">ALLOWANCES</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allowances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">allowances</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">ALLOWANCES</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">allowances</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_approve</span><span class="p">(</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">)</span>  <span class="p">{</span>

    <span class="nx">__setApproved</span><span class="p">(</span> <span class="nx">tokenId</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;Approval&#39;</span><span class="p">,</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">),</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_getApproved</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">_exists</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">),</span> <span class="s2">&quot;ERC721: approved query for nonexistent token&quot;</span><span class="p">);</span>
    
    <span class="c1">// 读取 allowance 集合</span>
    <span class="kd">var</span> <span class="nx">allowances</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">ALLOWANCES</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allowances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">allowances</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        
        <span class="k">return</span> <span class="nx">allowances</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">];</span> 
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>  
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getApproved</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span> <span class="c1">// tokenId</span>

    <span class="k">return</span> <span class="nx">_getApproved</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__getIsAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">to</span><span class="p">){</span>

    <span class="c1">// 读取 全部授权的集合</span>
    <span class="kd">var</span> <span class="nx">allApproved</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">ISALLAPPROVED</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allApproved</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">][</span><span class="nx">to</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;_owner can not be empty!&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;_operator can not be empty!&quot;</span><span class="p">);</span>

    <span class="k">return</span>  <span class="nx">__getIsAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isApprovedForAll</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span> <span class="c1">// owner, operator</span>

    <span class="k">return</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">operator</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">__setAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">isAllApproved</span><span class="p">){</span>
    
    <span class="c1">// 读取 全部授权的集合</span>
    <span class="kd">var</span> <span class="nx">allApproved</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">ISALLAPPROVED</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allApproved</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">inner_allApproved</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inner_allApproved</span><span class="p">;</span> 
    <span class="p">}</span>
    
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;allApproved:&quot;</span> <span class="o">+</span> <span class="nx">allApproved</span><span class="p">);</span>
    
    <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">][</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isAllApproved</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;allApproved after:&quot;</span> <span class="o">+</span> <span class="nx">allApproved</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">ISALLAPPROVED</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">allApproved</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_setApprovalForAll</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span> <span class="o">!==</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot;ERC721: approve to caller&quot;</span><span class="p">);</span>
    <span class="c1">// 设置 全部授权</span>
    <span class="nx">__setAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">);</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;ApprovalForAll&#39;</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 设置 全部授权</span>
<span class="kd">function</span> <span class="nx">setApprovalForAll</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span>  <span class="p">{</span>

    <span class="k">return</span> <span class="nx">_setApprovalForAll</span><span class="p">(</span><span class="nx">sender_g</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">isApproved</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_transfer</span><span class="p">(</span>
     <span class="kr">from</span><span class="p">,</span>
     <span class="nx">to</span><span class="p">,</span>
     <span class="nx">tokenId</span>
<span class="p">)</span>  <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;_ownerOf(tokenId): (&#39;</span> <span class="o">+</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;from: (&#39;</span> <span class="o">+</span> <span class="kr">from</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="o">===</span> <span class="kr">from</span><span class="p">,</span> <span class="s2">&quot;ERC721: transfer from incorrect owner&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;ERC721: transfer to the zero address&quot;</span><span class="p">);</span>

    <span class="nx">_approve</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">balances</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">BALANCEOF</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">balances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="kr">from</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="kr">from</span><span class="p">];</span>
        <span class="nx">balances</span><span class="p">[</span><span class="kr">from</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span> <span class="o">-</span> <span class="mf">1</span><span class="p">;</span>  
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">tempTo</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">];</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tempTo</span> <span class="o">+</span> <span class="mf">1</span><span class="p">;</span> 
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span><span class="p">;</span> 
    <span class="p">}</span>
    
    <span class="c1">// 读取 tokens 集合</span>
    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">dataToken</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dataToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">dataToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">tokens</span><span class="p">[</span><span class="nx">tokenId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">BALANCEOF</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">balances</span><span class="p">));</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">TOKENS</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;Transfer&#39;</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_isApprovedOrOwner</span><span class="p">(</span><span class="nx">spender</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">)</span>  <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;_exists(tokenId): &quot;</span> <span class="o">+</span> <span class="nx">_exists</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">));</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">_exists</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">),</span> <span class="s2">&quot;ERC721: operator query for nonexistent token&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;owner: &quot;</span> <span class="o">+</span> <span class="nx">owner</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;_getApproved(tokenId): &quot;</span> <span class="o">+</span> <span class="nx">_getApproved</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">));</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;_isApprovedForAll(owner, spender): &quot;</span> <span class="o">+</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">spender</span><span class="p">));</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">spender</span> <span class="o">===</span> <span class="nx">owner</span> <span class="o">||</span> <span class="nx">_getApproved</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span> <span class="o">===</span> <span class="nx">spender</span> <span class="o">||</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">spender</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">approve</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span>  <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span> <span class="c1">// to,  tokenId</span>

    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_ownerOf</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">to</span> <span class="o">!==</span> <span class="nx">owner</span><span class="p">,</span> <span class="s2">&quot;ERC721: approval to current owner&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;approve-sender_g:&quot;</span> <span class="o">+</span> <span class="nx">sender_g</span> <span class="o">+</span> <span class="s2">&quot;  owner:&quot;</span> <span class="o">+</span> <span class="nx">owner</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span>
        <span class="nx">sender_g</span> <span class="o">===</span> <span class="nx">owner</span> <span class="o">||</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">sender_g</span><span class="p">),</span>
        <span class="s2">&quot;ERC721: approve caller is not owner nor approved for all&quot;</span>
    <span class="p">);</span>

    <span class="nx">_approve</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transferFrom</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span> <span class="c1">// from、to、tokenId</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">_isApprovedOrOwner</span><span class="p">(</span><span class="nx">sender_g</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">),</span> <span class="s2">&quot;ERC721: transfer caller is not owner nor approved&quot;</span><span class="p">);</span>

    <span class="nx">_transfer</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="kr">from</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">input_str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;mint&#39;</span><span class="p">){</span>
        <span class="nx">mint</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;transferFrom&#39;</span><span class="p">){</span>
        <span class="nx">transferFrom</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;approve&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">approve</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;setApprovalForAll&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setApprovalForAll</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">else</span><span class="p">{</span>
        <span class="k">throw</span> <span class="s1">&#39;&lt;Main interface passes an invalid operation type&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">query</span><span class="p">(</span><span class="nx">input_str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">input</span>  <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span><span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;nameOfNFT&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">nameOfNFT</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;symbol&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">symbol</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;balanceOf&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;ownerOf&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">ownerOf</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;isApprovedForAll&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">isApprovedForAll</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;getApproved&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">getApproved</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
       	<span class="k">throw</span> <span class="s1">&#39;&lt;unidentified operation type&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="erc1155">
<h2>ERC1155合约<a class="headerlink" href="#erc1155" title="Permalink to this headline"></a></h2>
<p>本节描述通过星火链网实现并部署ERC1155智能合约。</p>
<p>ERC1155在一定程度上融合了ERC-20和ERC-721的功能。其主要用途包括了发行同质化代币和非同质化代币。同质化代币是指：能像ERC-20一样发布各样的代币类型；与此同时，ERC-1155标准更是能够发行NFT，且能基于一个合约同时发行多个NFT，有关ERC1155标准可以参考<a class="reference external" href="https://eips.ethereum.org/EIPS/eip-1155">官方文档</a>。</p>
<section id="id5">
<h3>合约说明<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<ul>
<li><p><strong>合约接口</strong></p>
<p>注意：在实现转账功能时，如果接收方的地址没有拥有者，或者是一个合约地址，那么NFT被转出去之后，就意味着该NFT以后将没有流通的功能了。因此转账的时候，要慎重。若是合约地址，可以采取安全转账的方式，根据ERC165的方式判断该合约是否实现了onERC1155Received接口，若是没有实现，则智能合约的执行将被中止，若实现了，说明该合约遵守了ERC1155合约的标准，确保以后NFT可以进行流通，则转账继续。目前，在星火链网上实现的非同质化代币智能合约模板仅提供基础的功能，并没有提供安全转账的功能。</p>
</li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接口</p></th>
<th class="head"><p>返回值</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>uri (uint256 _id)</p></td>
<td><p>string</p></td>
<td><p>根据 _id 去查询的，通常为一个json字符串，描述了 NFT的图片、介绍等详细信息</p></td>
</tr>
<tr class="row-odd"><td><p>safeTransferFrom(address _from, address _to, uint256 _id, uint256 _value, bytes calldata _data) ;</p></td>
<td><p>无</p></td>
<td><p>代币转移接口，从 _from 账号发送  _value 个标识为 _id的代币到  _to 账号</p></td>
</tr>
<tr class="row-even"><td><p>safeBatchTransferFrom(address _from, address _to, uint256[] calldata _ids, uint256[] calldata _values, bytes calldata _data)</p></td>
<td><p>无</p></td>
<td><p>批量代币转移接口，从 _from 账号发送  _values[i] 个标识为 _ids[i] 的代币到  _to 账号。_values  和 _ids数组需要长度一致。</p></td>
</tr>
<tr class="row-odd"><td><p>balanceOf(address _owner, uint256 _id)</p></td>
<td><p>uint256</p></td>
<td><p>查询_owner 账户所持有的 标识为 _id 的代币 的数量</p></td>
</tr>
<tr class="row-even"><td><p>balanceOfBatch(address[] calldata _owners, uint256[] calldata _ids)</p></td>
<td><p>uint256[]</p></td>
<td><p>查询 _owners[i]  账户所持有的 标识为  _ids[i]  的代币 的数量。_owners 和 _ids 数组需要长度一致。</p></td>
</tr>
<tr class="row-odd"><td><p>setApprovalForAll(address , bool)</p></td>
<td><p>无</p></td>
<td><p>设置授权</p></td>
</tr>
<tr class="row-even"><td><p>isApprovedForAll(address , address)</p></td>
<td><p>bool</p></td>
<td><p>查询某个账户是否授权给某个账户</p></td>
</tr>
<tr class="row-odd"><td><p>onERC1155Received(address _operator, address _from, uint256 _id, uint256 _value, bytes calldata _data)</p></td>
<td><p>bytes4</p></td>
<td><p>在 safe转账下，具备接收NFT功能的智能合约必须实现该接口。</p></td>
</tr>
<tr class="row-even"><td><p>onERC1155BatchReceived(address _operator, address _from, uint256[] calldata _ids, uint256[] calldata _values, bytes calldata _data)</p></td>
<td><p>bytes4</p></td>
<td><p>在 safe批量转账下，具备接收NFT功能的智能合约必须实现该接口。</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id6">
<h3>Solidity合约<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>合约文件</strong></p></li>
</ul>
<div class="highlight-solidity notranslate"><div class="highlight"><pre><span></span>pragma solidity ^0.4.26;

contract ERC1155 {

    // Mapping from token ID to account balances （某个代币 -- 某个账户地址 -- 金额）
    mapping(uint256 =&gt; mapping(address =&gt; uint256)) private _balances;

    // Mapping from account to operator approvals （账户地址A ---- 对账户地址B是否进行了授权） 
    mapping(address =&gt; mapping(address =&gt; bool)) private _operatorApprovals;

    // 链下的资源链接，用于记录保存token的具体介绍信息   https://token-cdn-domain/{id}.json
    string private _uri;

    // 单个转账时的事件
    event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 id, uint256 value);
    // 批量转账时的事件
    event TransferBatch( address indexed operator, address indexed from, address indexed to, uint256[] ids, uint256[] values
    );
    // 授权时的事件
    event ApprovalForAll(address indexed account, address indexed operator, bool approved);
    // 更新uri时的事件
    event URI(string value, uint256 indexed id);
    
    address public fundation; // 管理员

    modifier onlyFundation() {
        require(msg.sender == fundation);
        _;
    }

    /**
     * 初始化构造
     */
    function TokenERC1155(string memory uri_) public {
        fundation = msg.sender;    
        _setURI(uri_);                         
    }
    
    constructor(string memory uri_) {
        fundation = msg.sender;    
        _setURI(uri_);
    }

    function uri(uint256) public view  returns (string memory) {
        return _uri;
    }

    /**
     * 查询单个账户的余额
     * @param account 查询的账户地址
     * @param id 代币的标识符
     */
    function balanceOf(address account, uint256 id) public view returns (uint256) {
        require(account != address(0), &quot;ERC1155: balance query for the zero address&quot;);
        return _balances[id][account];
    }
  
    /**
     * 批量查询多个账户的余额
     * @param accounts 查询的账户地址 数组
     * @param ids 代币的标识符 数组
     */
    function balanceOfBatch(address[] memory accounts, uint256[] memory ids)
        public
        view    
        returns (uint256[] memory)
    {
        require(accounts.length == ids.length, &quot;ERC1155: accounts and ids length mismatch&quot;);

        uint256[] memory batchBalances = new uint256[](accounts.length);

        for (uint256 i = 0; i &lt; accounts.length; ++i) {
            batchBalances[i] = balanceOf(accounts[i], ids[i]);
        }

        return batchBalances;
    }

    /**
     * 详见 _setApprovalForAll
     */
    function setApprovalForAll(address operator, bool approved) public {
        _setApprovalForAll(msg.sender, operator, approved);
    }

    /**
     * 查询账户是否授权给 某个账户
     * @param account 需要查询的账户地址
     * @param operator 授权的账户地址
     */
    function isApprovedForAll(address account, address operator) public view  returns (bool) {
        return _operatorApprovals[account][operator];
    }

    /**
     * 详见 _safeTransferFrom
     */
    function safeTransferFrom(
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) public  {
        require(
            from == msg.sender || isApprovedForAll(from, msg.sender),
            &quot;ERC1155: caller is not owner nor approved&quot;
        );
        _safeTransferFrom(from, to, id, amount, data);
    }

    /**
     * 详见 _safeBatchTransferFrom
     */
    function safeBatchTransferFrom(
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) public  {
        require(
            from == msg.sender || isApprovedForAll(from, msg.sender),
            &quot;ERC1155: transfer caller is not owner nor approved&quot;
        );
        _safeBatchTransferFrom(from, to, ids, amounts, data);
    }

    /**
     * 从from账户，转账 amount 个 token为id的资产到to账户。
     * @param from 转账的发送账户地址
     * @param to 转账的接收账户地址
     * @param id token的标识符
     * @param amount 转账的数量     
     * @param data 转账的信息
     */
    function _safeTransferFrom(
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) internal {
        require(to != address(0), &quot;ERC1155: transfer to the zero address&quot;);

        address operator = msg.sender;
        uint256 fromBalance = _balances[id][from];
        require(fromBalance &gt;= amount, &quot;ERC1155: insufficient balance for transfer&quot;);
        _balances[id][from] = fromBalance - amount;
        _balances[id][to] += amount;

        emit TransferSingle(operator, from, to, id, amount);
    }

    /**
     * 从from账户批量转账资产到to账户。
     * @param from 转账的发送账户地址
     * @param to 转账的接收账户地址
     * @param ids token的标识符数组
     * @param amounts 转账的数量数组     
     * @param data 转账的信息
     */
    function _safeBatchTransferFrom(
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) internal {
        require(ids.length == amounts.length, &quot;ERC1155: ids and amounts length mismatch&quot;);
        require(to != address(0), &quot;ERC1155: transfer to the zero address&quot;);

        address operator = msg.sender;
        for (uint256 i = 0; i &lt; ids.length; ++i) {
            uint256 id = ids[i];
            uint256 amount = amounts[i];

            uint256 fromBalance = _balances[id][from];
            require(fromBalance &gt;= amount, &quot;ERC1155: insufficient balance for transfer&quot;);
            _balances[id][from] = fromBalance - amount;
            _balances[id][to] += amount;
        }

        emit TransferBatch(operator, from, to, ids, amounts);
    }
  
    function _setURI(string memory newuri) internal {
        _uri = newuri;
    }

   /**
     * 铸造代币
     * @param to 接收账户地址
     * @param id token的标识符
     * @param amount 转账的数量     
     * @param data 转账的信息
     */
    function mint (
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) onlyFundation public {
        require(to != address(0), &quot;ERC1155: mint to the zero address&quot;);

        address operator = msg.sender;
        _balances[id][to] += amount;
        emit TransferSingle(operator, address(0), to, id, amount);
    }

   /**
     * 批量铸造代币
     * @param to 接收账户地址
     * @param ids token的标识符数组
     * @param amounts 转账的数量数组  
     * @param data 转账的信息
     */
    function mintBatch(
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) onlyFundation public {
        require(to != address(0), &quot;ERC1155: mint to the zero address&quot;);
        require(ids.length == amounts.length, &quot;ERC1155: ids and amounts length mismatch&quot;);

        address operator = msg.sender;

        for (uint256 i = 0; i &lt; ids.length; i++) {
            _balances[ids[i]][to] += amounts[i];
        }
        emit TransferBatch(operator, address(0), to, ids, amounts);
    }

    /**
     * 为账户下所有的资产设置授权
     * @param owner 需要授权的账户
     * @param operator 接受授权的账户
     * @param approved 是否授权
     */
    function _setApprovalForAll(
        address owner,
        address operator,
        bool approved
    ) internal {
        require(owner != operator, &quot;ERC1155: setting approval status for self&quot;);
        _operatorApprovals[owner][operator] = approved;
        emit ApprovalForAll(owner, operator, approved);
    } 
}
</pre></div>
</div>
</section>
<section id="id7">
<h3>JavaScript合约<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h3>
<p>**合约文件 - JavaScript **</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="c1">// 管理员  </span>
<span class="kd">const</span> <span class="nx">FUNDATION</span> <span class="o">=</span> <span class="s2">&quot;_fundation&quot;</span><span class="p">;</span>
<span class="c1">// uri</span>
<span class="kd">const</span> <span class="nx">URI</span> <span class="o">=</span> <span class="s2">&quot;_uri&quot;</span><span class="p">;</span>

<span class="c1">// 账户有 几个NFT      ( uint256(代币类型), map(address, uint256))</span>
<span class="kd">const</span> <span class="nx">BALANCES</span> <span class="o">=</span> <span class="s2">&quot;_balances&quot;</span><span class="p">;</span>

<span class="c1">// 全部 NFT 的授权集合    (address, map(address, bool))</span>
<span class="kd">const</span> <span class="nx">OPERATORAPPROVALS</span> <span class="o">=</span> <span class="s2">&quot;_operatorApprovals&quot;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">sender_g</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">chainCode_g</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">chainCode</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">_setURI</span><span class="p">(</span><span class="nx">newuri</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">URI</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">newuri</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	是否为合约所有者</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">isContractOwner</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">FUNDATION</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">===</span> <span class="nx">owner</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">input_str</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span> <span class="c1">// uri</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;input_str: (&#39;</span> <span class="o">+</span> <span class="nx">input_str</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>

    <span class="nx">_setURI</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">FUNDATION</span><span class="p">,</span> <span class="nx">sender_g</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">uri</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">URI</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">account</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//读取 数组集合</span>
    <span class="kd">var</span> <span class="nx">balances</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">BALANCES</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">balances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">inner_balances</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inner_balances</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">account</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="k">return</span> <span class="mf">0</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">account</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">account</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
   
    <span class="c1">// 读取 全部授权的集合</span>
    <span class="kd">var</span> <span class="nx">balances</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">BALANCES</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">balances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">inner_balances</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inner_balances</span><span class="p">;</span> 
    <span class="p">}</span>
        
    <span class="nx">balances</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">account</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;balances:&quot;</span> <span class="o">+</span> <span class="nx">balances</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">BALANCES</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">balances</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">account</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">account</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;ERC1155: balance query for the zero address&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">account</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">balanceOfBatch</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span> 

    <span class="kd">var</span> <span class="nx">accounts</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">accounts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ids</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;ERC1155: accounts and ids length mismatch&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">batchBalances</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">accounts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">batchBalances</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">accounts</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
   
    <span class="k">return</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">batchBalances</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__setAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">isAllApproved</span><span class="p">){</span>
    
    <span class="c1">// 读取 全部授权的集合</span>
    <span class="kd">var</span> <span class="nx">allApproved</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">OPERATORAPPROVALS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allApproved</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">inner_allApproved</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inner_allApproved</span><span class="p">;</span> 
    <span class="p">}</span>
        
    <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">][</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isAllApproved</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;allApproved:&quot;</span> <span class="o">+</span> <span class="nx">allApproved</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">OPERATORAPPROVALS</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">allApproved</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_setApprovalForAll</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span> <span class="p">,</span><span class="nx">isApproved</span><span class="p">)</span>  <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span> <span class="o">!==</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot;ERC1155: setting approval status for self&quot;</span><span class="p">);</span>

    <span class="nx">__setAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">);</span>
    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;ApprovalForAll&#39;</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setApprovalForAll</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">operator</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isApproved</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">isApproved</span><span class="p">;</span> <span class="c1">// bool 类型</span>

    <span class="nx">_setApprovalForAll</span><span class="p">(</span><span class="nx">sender_g</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">isApproved</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__getIsAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">to</span><span class="p">){</span>

    <span class="c1">// 读取 全部授权的集合</span>
    <span class="kd">var</span> <span class="nx">allApproved</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Chain</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">OPERATORAPPROVALS</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">allApproved</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">inner_allApproved</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inner_allApproved</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">][</span><span class="nx">to</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">allApproved</span><span class="p">[</span><span class="nx">owner</span><span class="p">][</span><span class="nx">to</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;_owner can not be empty!&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;_operator can not be empty!&quot;</span><span class="p">);</span>

    <span class="k">return</span>  <span class="nx">__getIsAllApproved</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">operator</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isApprovedForAll</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">account</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">operator</span><span class="p">;</span> 

    <span class="k">return</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">operator</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_safeTransferFrom</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;ERC1155: transfer to the zero address&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">sender_g</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">fromBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">from</span><span class="p">);</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">fromBalance</span> <span class="o">&gt;=</span> <span class="nx">amount</span><span class="p">,</span> <span class="s2">&quot;ERC1155: insufficient balance for transfer&quot;</span><span class="p">);</span>

    <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">fromBalance</span> <span class="o">-</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">toBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
    <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">toBalance</span> <span class="o">+</span> <span class="nx">amount</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;TransferSingle&#39;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">safeTransferFrom</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="kr">from</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="kr">from</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="c1">// int</span>
    <span class="kd">var</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">amount</span><span class="p">;</span> <span class="c1">// int</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span> 

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kr">from</span> <span class="o">===</span> <span class="nx">sender_g</span> <span class="o">||</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="nx">sender_g</span><span class="p">),</span> <span class="s2">&quot;ERC1155: caller is not owner nor approved&quot;</span><span class="p">);</span>

    <span class="nx">_safeTransferFrom</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_safeBatchTransferFrom</span><span class="p">(</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nx">amounts</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span>  <span class="p">{</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">ids</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">amounts</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;ERC1155:  ids and amounts length mismatch&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">,</span> <span class="s2">&quot;ERC1155:  transfer to the zero address&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">sender_g</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">amount</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">fromBalance</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">toBalance</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">amount</span> <span class="o">=</span> <span class="nx">amounts</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="nx">fromBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">from</span><span class="p">);</span>
        <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">fromBalance</span> <span class="o">&gt;=</span> <span class="nx">amount</span><span class="p">,</span> <span class="s2">&quot;ERC1155:  insufficient balance for transfer&quot;</span><span class="p">);</span>

        <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">fromBalance</span> <span class="o">-</span> <span class="nx">amount</span><span class="p">);</span>
        <span class="nx">toBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
        <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">toBalance</span> <span class="o">+</span> <span class="nx">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;TransferBatch&#39;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ids</span><span class="p">),</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">amounts</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">safeBatchTransferFrom</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="kr">from</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="kr">from</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ids</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">amounts</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">amounts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span> 

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kr">from</span> <span class="o">===</span> <span class="nx">sender_g</span> <span class="o">||</span> <span class="nx">_isApprovedForAll</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="nx">sender_g</span><span class="p">),</span> <span class="s2">&quot;ERC1155: caller is not owner nor approved&quot;</span><span class="p">);</span>

    <span class="nx">_safeBatchTransferFrom</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nx">amounts</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mint</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">isContractOwner</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">){</span>
        <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mint&#39;</span> <span class="o">+</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="c1">//int </span>
    <span class="kd">var</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">amount</span><span class="p">;</span> <span class="c1">//int </span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="p">,</span> <span class="s2">&quot;ERC1155: mint to the zero address&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">sender_g</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">toBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
    <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">to</span> <span class="p">,</span> <span class="nx">toBalance</span> <span class="o">+</span> <span class="nx">amount</span><span class="p">);</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;TransferSingle&#39;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mintBatch</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">isContractOwner</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">){</span>
        <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mint&#39;</span> <span class="o">+</span> <span class="nx">Chain</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ids</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">amounts</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">amounts</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="p">,</span> <span class="s2">&quot;ERC1155: mint to the zero address&quot;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">ids</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">amounts</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;ERC1155: ids and amounts length mismatch&quot;</span><span class="p">);</span>

    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mintBatch-ids: (&#39;</span> <span class="o">+</span> <span class="nx">ids</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>
    <span class="nx">Utils</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mintBatch-amounts: (&#39;</span> <span class="o">+</span> <span class="nx">amounts</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">operator</span> <span class="o">=</span> <span class="nx">sender_g</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">toBalance</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">toBalance</span> <span class="o">=</span> <span class="nx">_getBalanceOf</span><span class="p">(</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">to</span><span class="p">);</span>
         <span class="nx">_setBalanceOfForKey</span><span class="p">(</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">to</span> <span class="p">,</span> <span class="nx">toBalance</span> <span class="o">+</span> <span class="nx">amounts</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">Chain</span><span class="p">.</span><span class="nx">tlog</span><span class="p">(</span><span class="s1">&#39;TransferBatch&#39;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ids</span><span class="p">),</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">amounts</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">input_str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;mint&#39;</span><span class="p">){</span>
        <span class="nx">mint</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;mintBatch&#39;</span><span class="p">){</span>
        <span class="nx">mintBatch</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;safeTransferFrom&#39;</span><span class="p">){</span>
        <span class="nx">safeTransferFrom</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;safeBatchTransferFrom&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">safeBatchTransferFrom</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;setApprovalForAll&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setApprovalForAll</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">else</span><span class="p">{</span>
        <span class="k">throw</span> <span class="s1">&#39;&lt;Main interface passes an invalid operation type&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">query</span><span class="p">(</span><span class="nx">input_str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">input</span>  <span class="o">=</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input_str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span><span class="p">{};</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;uri&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;balanceOf&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;balanceOfBatch&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">balanceOfBatch</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;isApprovedForAll&#39;</span><span class="p">){</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">isApprovedForAll</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
       	<span class="k">throw</span> <span class="s1">&#39;&lt;unidentified operation type&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="%E6%98%9F%E7%81%AB%E9%93%BESolidity%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91.html" class="btn btn-neutral float-left" title="星火链Solidity合约开发" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, 中国信息通信研究院.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>